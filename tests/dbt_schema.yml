# =======================================================================
#  DBT SCHEMA TESTS - INTEROP_MASTERDATA_FHIR_COLOMBIA
#  Objetivo: Validar integridad, relaciones y dominios de datos en el
#            esquema hcd del proyecto interop_db.
#  Compatibilidad: PostgreSQL / Citus - dbt >= 1.6
#  Autor: Laboratorio acad√©mico-productivo
# =======================================================================

version: 2

models:

# -----------------------------------------------------------------------
# üß¨ 1. usuario (FHIR: Patient)
# -----------------------------------------------------------------------
- name: usuario
  description: "Datos maestros de los pacientes (recurso Patient)."
  columns:
    - name: documento_id
      description: "Identificador √∫nico del paciente."
      tests:
        - unique
        - not_null

    - name: nombre_completo
      description: "Nombre completo del paciente."
      tests:
        - not_null

    - name: fecha_nacimiento
      description: "Fecha de nacimiento debe estar presente."
      tests:
        - not_null

    - name: sexo
      description: "Sexo del paciente. Valores permitidos: M, F, Intersex."
      tests:
        - accepted_values:
            values: ["M", "F", "Intersex"]

    - name: zona_residencia
      description: "Zona de residencia del paciente."
      tests:
        - accepted_values:
            values: ["Urbana", "Rural", "Dispersa"]

# -----------------------------------------------------------------------
# üè• 2. atencion (FHIR: Encounter)
# -----------------------------------------------------------------------
- name: atencion
  description: "Eventos cl√≠nicos de atenci√≥n al paciente (Encounter)."
  columns:
    - name: atencion_id
      description: "Identificador √∫nico de la atenci√≥n."
      tests:
        - unique
        - not_null

    - name: documento_id
      description: "Debe existir en la tabla usuario."
      tests:
        - relationships:
            to: ref('usuario')
            field: documento_id

    - name: modalidad_entrega
      description: "Modalidad de la atenci√≥n."
      tests:
        - accepted_values:
            values: ["Presencial", "Telemedicina", "Domiciliaria"]

    - name: entorno_atencion
      description: "Tipo de entorno cl√≠nico."
      tests:
        - accepted_values:
            values: ["Urgencias", "Hospitalizaci√≥n", "Consulta", "UCI", "Procedimiento", "Domiciliaria"]

# -----------------------------------------------------------------------
# üíä 3. tecnologia_salud (FHIR: MedicationAdministration / Procedure)
# -----------------------------------------------------------------------
- name: tecnologia_salud
  description: "Tecnolog√≠as en salud usadas en la atenci√≥n."
  columns:
    - name: tecnologia_id
      description: "Identificador √∫nico de tecnolog√≠a."
      tests:
        - unique
        - not_null

    - name: atencion_id
      description: "Debe existir en la tabla atencion."
      tests:
        - relationships:
            to: ref('atencion')
            field: atencion_id

    - name: dias_tratamiento
      description: "Debe estar entre 0 y 365."
      tests:
        - dbt_expectations.expect_column_values_to_be_between:
            min_value: 0
            max_value: 365

# -----------------------------------------------------------------------
# ü©∫ 4. diagnostico (FHIR: Condition)
# -----------------------------------------------------------------------
- name: diagnostico
  description: "Diagn√≥sticos cl√≠nicos asociados a una atenci√≥n."
  columns:
    - name: diagnostico_id
      description: "Identificador √∫nico del diagn√≥stico."
      tests:
        - unique
        - not_null

    - name: atencion_id
      description: "Debe existir en la tabla atencion."
      tests:
        - relationships:
            to: ref('atencion')
            field: atencion_id

    - name: diagnostico_ingreso
      description: "C√≥digo CIE-10 v√°lido."
      tests:
        - relationships:
            to: ref('catalogo_cie10')
            field: codigo

# -----------------------------------------------------------------------
# üìã 5. egreso (FHIR: Encounter.dischargeDisposition)
# -----------------------------------------------------------------------
- name: egreso
  description: "Registro del egreso del paciente tras la atenci√≥n."
  columns:
    - name: egreso_id
      description: "Identificador √∫nico del egreso."
      tests:
        - unique
        - not_null

    - name: atencion_id
      description: "Debe existir en la tabla atencion."
      tests:
        - relationships:
            to: ref('atencion')
            field: atencion_id

    - name: condicion_salida
      description: "Condici√≥n del paciente al egreso."
      tests:
        - accepted_values:
            values: ["Vivo", "Mejorado", "Remitido", "Fallecido"]

# -----------------------------------------------------------------------
# üë®‚Äç‚öïÔ∏è 6. profesional_salud (FHIR: Practitioner)
# -----------------------------------------------------------------------
- name: profesional_salud
  description: "Profesionales que participaron en la atenci√≥n cl√≠nica."
  columns:
    - name: id_personal_salud
      description: "Identificador √∫nico del profesional."
      tests:
        - unique
        - not_null

    - name: especialidad
      description: "Campo obligatorio."
      tests:
        - not_null

